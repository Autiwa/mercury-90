module opacity_hure
  use types_numeriques
  use physical_constant
  
  implicit none
  
  private
  
  public :: get_opacity_hure, init_opacity_hure, test_opacity_interpolation
  
  real(double_precision) :: dlog_r ! Space between two 'r' values in the opacity table (this width must be constant)
  real(double_precision) :: dlog_t ! Space between two temperature values in the opacity table (this width must be constant)
  
  integer :: nb_r_points ! number of density points
  integer :: nb_t_points ! number of temperature points

  real(double_precision), dimension(:), allocatable :: hure_r ! Array for R, which is a mix parameter between T and rho
  real(double_precision), dimension(:), allocatable :: hure_t ! temperature points
  real(double_precision), dimension(:,:), allocatable :: hure_k_table ! absorption coefficients (first dimension is T, the second is R)
  
contains

  subroutine init_opacity_hure()
    ! Initialisation of the opacity table by reading the data file.
    implicit none
    
    ! Rosseland opacity table for the element mix X=0.70, Y=0.28 and Z=0.20
    ! based on Seaton et al. (1994),  Alexander & Ferguson (1994) ApJ, 437, 879, 
    ! and Henning & Stognienko R. (1996), A&A 311, 291 in OP-format (log T vs log R)
    ! 000024 000141 --- number of points in log R and log T
    ! The opacity is given in log also. Note that this is log10 for R, T and opacity.
    ! Note also that R is defined as : log(R) = log(rho) + 18. - 3.0 * log(T) with rho in g/cm**3
    
    integer, parameter :: sample_r = 24 ! number of points for R (special variable, mix of T and rho)
    integer, parameter :: sample_t = 141 ! number of points for the temperature
    
    real(double_precision), dimension(sample_r), parameter :: log_r = [-7.500, -7.000, -6.500, -6.000, -5.500, -5.000, -4.500, &
      -4.000, -3.500, -3.000, -2.500, -2.000, -1.500, -1.000, -0.500, +0.000, +0.500, +1.000, +1.500, +2.000, +2.500, +3.000, &
      +3.500, +4.000]
    real(double_precision), dimension(sample_t), parameter :: log_t = [1.000, 1.050, 1.100, 1.150, 1.200, 1.250, 1.300, 1.350, &
      1.400, 1.450, 1.500, 1.550, 1.600, 1.650, 1.700, 1.750, 1.800, 1.850, 1.900, 1.950, 2.000, 2.050, 2.100, 2.150, 2.200, &
      2.250, 2.300, 2.350, 2.400, 2.450, 2.500, 2.550, 2.600, 2.650, 2.700, 2.750, 2.800, 2.850, 2.900, 2.950, 3.000, 3.050, &
      3.100, 3.150, 3.200, 3.250, 3.300, 3.350, 3.400, 3.450, 3.500, 3.550, 3.600, 3.650, 3.700, 3.750, 3.800, 3.850, 3.900, &
      3.950, 4.000, 4.050, 4.100, 4.150, 4.200, 4.250, 4.300, 4.350, 4.400, 4.450, 4.500, 4.550, 4.600, 4.650, 4.700, 4.750, &
      4.800, 4.850, 4.900, 4.950, 5.000, 5.050, 5.100, 5.150, 5.200, 5.250, 5.300, 5.350, 5.400, 5.450, 5.500, 5.550, 5.600, &
      5.650, 5.700, 5.750, 5.800, 5.850, 5.900, 5.950, 6.000, 6.050, 6.100, 6.150, 6.200, 6.250, 6.300, 6.350, 6.400, 6.450, &
      6.500, 6.550, 6.600, 6.650, 6.700, 6.750, 6.800, 6.850, 6.900, 6.950, 7.000, 7.050, 7.100, 7.150, 7.200, 7.250, 7.300, &
      7.350, 7.400, 7.450, 7.500, 7.550, 7.600, 7.650, 7.700, 7.750, 7.800, 7.850, 7.900, 7.950, 8.000]
    
    ! It is not the right shape and order, so becarefull. One must use transpose(reshape())
    real(double_precision), dimension(sample_t, sample_r), parameter :: kappa = transpose(reshape(&
      [-1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, &
       -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.775, -1.592, -1.592, -1.592, -1.592, &
       -1.592, -1.592, -1.592, -1.592, -1.592, -1.592, -1.592, -1.592, -1.592, -1.592, -1.592, -1.592, -1.592, -1.592, &
       -1.592, -1.592, -1.592, -1.592, -1.592, -1.592, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, &
       -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, -1.447, &
       -1.447, -1.447, +0.000, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, &
       -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, -1.323, +0.000, -1.213, &
       -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, &
       -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, -1.213, +0.000, -1.112, -1.112, -1.112, -1.112, -1.112, &
       -1.112, -1.112, -1.112, -1.112, -1.112, -1.112, -1.112, -1.112, -1.112, -1.112, -1.112, -1.112, -1.112, -1.112, &
       -1.112, -1.112, -1.112, -1.112, +0.000, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, &
       -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, -1.016, &
       +0.000, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, &
       -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, -0.925, +0.000, -0.836, -0.836, -0.836, &
       -0.836, -0.836, -0.836, -0.836, -0.836, -0.836, -0.836, -0.836, -0.836, -0.836, -0.836, -0.836, -0.836, -0.836, &
       -0.836, -0.836, -0.836, -0.836, -0.836, -0.836, +0.000, -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, &
       -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, -0.749, &
       -0.749, -0.749, +0.000, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, &
       -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, -0.661, +0.000, -0.574, &
       -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, &
       -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, -0.574, +0.000, -0.485, -0.485, -0.485, -0.485, -0.485, &
       -0.485, -0.485, -0.485, -0.485, -0.485, -0.485, -0.485, -0.485, -0.485, -0.485, -0.485, -0.485, -0.485, -0.485, &
       -0.485, -0.485, -0.485, -0.485, +0.000, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, &
       -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, -0.394, &
       +0.000, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, &
       -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, -0.300, +0.000, -0.204, -0.204, -0.204, &
       -0.204, -0.204, -0.204, -0.204, -0.204, -0.204, -0.204, -0.204, -0.204, -0.204, -0.204, -0.204, -0.204, -0.204, &
       -0.204, -0.204, -0.204, -0.204, -0.204, -0.204, +0.000, -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, &
       -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, -0.105, &
       -0.105, -0.105, +0.000, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, &
       -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, -0.002, +0.000, +0.105, &
       +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, &
       +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.105, +0.000, +0.213, +0.213, +0.213, +0.213, +0.213, &
       +0.213, +0.213, +0.213, +0.213, +0.213, +0.213, +0.213, +0.213, +0.213, +0.213, +0.213, +0.213, +0.213, +0.213, &
       +0.213, +0.213, +0.213, +0.213, +0.000, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, &
       +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, +0.315, &
       +0.000, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, &
       +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.403, +0.000, +0.479, +0.479, +0.479, &
       +0.479, +0.479, +0.479, +0.479, +0.479, +0.479, +0.479, +0.479, +0.479, +0.479, +0.479, +0.479, +0.479, +0.479, &
       +0.479, +0.479, +0.479, +0.479, +0.479, +0.479, +0.000, +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, &
       +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, +0.543, &
       +0.543, +0.543, +0.000, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, &
       +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.597, +0.000, +0.643, &
       +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, &
       +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.643, +0.000, +0.683, +0.683, +0.683, +0.683, +0.683, &
       +0.683, +0.683, +0.683, +0.683, +0.683, +0.683, +0.683, +0.683, +0.683, +0.683, +0.683, +0.683, +0.683, +0.683, &
       +0.683, +0.683, +0.683, +0.683, +0.000, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, &
       +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, +0.722, &
       +0.000, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, &
       +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.763, +0.000, +0.803, +0.803, +0.803, &
       +0.803, +0.803, +0.803, +0.803, +0.803, +0.803, +0.803, +0.803, +0.803, +0.803, +0.803, +0.803, +0.803, +0.803, &
       +0.803, +0.803, +0.803, +0.803, +0.803, +0.803, +0.000, +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, &
       +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, +0.836, &
       +0.836, +0.836, +0.000, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, &
       +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.852, +0.000, +0.854, &
       +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, &
       +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.854, +0.000, +0.859, +0.859, +0.859, +0.859, +0.859, &
       +0.859, +0.859, +0.859, +0.859, +0.859, +0.859, +0.859, +0.859, +0.859, +0.859, +0.859, +0.859, +0.859, +0.859, &
       +0.859, +0.859, +0.859, +0.859, +0.000, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, &
       +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, +0.885, &
       +0.000, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, &
       +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.842, +0.000, +0.551, +0.551, +0.551, &
       +0.551, +0.551, +0.551, +0.551, +0.551, +0.551, +0.551, +0.551, +0.551, +0.551, +0.551, +0.551, +0.551, +0.551, &
       +0.551, +0.551, +0.551, +0.551, +0.551, +0.551, +0.000, +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, &
       +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, +0.472, &
       +0.472, +0.472, +0.000, +0.474, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, &
       +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.481, +0.000, +0.440, &
       +0.458, +0.483, +0.506, +0.518, +0.519, +0.520, +0.520, +0.520, +0.520, +0.520, +0.520, +0.520, +0.520, +0.520, &
       +0.520, +0.520, +0.520, +0.520, +0.520, +0.520, +0.520, +0.520, +0.000, +0.265, +0.301, +0.360, +0.410, +0.446, &
       +0.487, +0.526, +0.549, +0.559, +0.560, +0.560, +0.560, +0.560, +0.560, +0.560, +0.560, +0.560, +0.560, +0.560, &
       +0.560, +0.560, +0.560, +0.560, +0.000, -0.078, -0.078, -0.055, -0.036, +0.040, +0.191, +0.296, +0.357, +0.419, &
       +0.489, +0.551, +0.579, +0.599, +0.603, +0.604, +0.605, +0.605, +0.605, +0.605, +0.605, +0.605, +0.605, +0.605, &
       +0.000, -2.423, -2.423, -2.423, -2.424, -2.424, -2.425, -1.346, -1.092, -0.862, -0.269, +0.060, +0.143, +0.354, &
       +0.505, +0.593, +0.626, +0.657, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -2.496, -2.448, -2.434, &
       -2.429, -2.428, -2.427, -2.427, -2.427, -2.428, -2.428, -2.429, -1.133, -0.936, -0.756, -0.653, +0.026, +0.413, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -4.011, -3.281, -2.702, -2.420, -2.329, -2.301, -2.291, &
       -2.288, -2.285, -2.284, -2.284, -2.285, -2.285, -2.284, -2.284, -2.280, -0.881, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, -5.131, -4.888, -4.409, -3.724, -3.012, -2.463, -2.186, -2.088, -2.057, -2.045, -2.040, &
       -2.037, -2.036, -2.034, -2.033, -2.032, -2.029, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -5.133, &
       -5.117, -5.060, -4.894, -4.515, -3.903, -3.194, -2.559, -2.134, -1.939, -1.869, -1.844, -1.834, -1.828, -1.825, &
       -1.822, -1.820, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -4.796, -4.896, -4.971, -5.004, -4.974, &
       -4.832, -4.479, -3.881, -3.174, -2.529, -2.055, -1.802, -1.698, -1.658, -1.641, -1.631, -1.623, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, -4.387, -4.460, -4.550, -4.650, -4.745, -4.812, -4.818, -4.688, -4.319, &
       -3.700, -2.990, -2.351, -1.885, -1.625, -1.507, -1.454, -1.428, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, -4.203, -4.207, -4.231, -4.274, -4.333, -4.404, -4.469, -4.503, -4.465, -4.279, -3.870, -3.270, -2.608, &
       -2.014, -1.596, -1.363, -1.245, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -4.162, -4.182, -4.169, -4.147, &
       -4.121, -4.102, -4.094, -4.086, -4.059, -3.996, -3.883, -3.695, -3.413, -3.019, -2.521, -1.979, -1.498, -1.169, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -3.808, -3.939, -4.032, -4.085, -4.100, -4.083, -4.036, -3.953, &
       -3.828, -3.652, -3.431, -3.177, -2.905, -2.626, -2.338, -2.037, -1.729, -1.432, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -3.103, -3.297, -3.478, -3.641, -3.782, -3.889, -3.940, -3.916, -3.792, -3.557, -3.234, -2.867, &
       -2.498, -2.147, -1.824, -1.518, -1.223, -0.935, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -2.298, -2.523, &
       -2.743, -2.952, -3.147, -3.323, -3.466, -3.547, -3.533, -3.391, -3.118, -2.740, -2.313, -1.882, -1.477, -1.106, &
       -0.766, -0.453, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -1.539, -1.767, -1.998, -2.225, -2.443, -2.644, &
       -2.813, -2.921, -2.933, -2.839, -2.651, -2.392, -2.072, -1.694, -1.277, -0.855, -0.453, -0.082, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.923, -1.113, -1.322, -1.537, -1.750, -1.950, -2.118, -2.225, -2.238, -2.147, &
       -1.982, -1.766, -1.520, -1.248, -0.945, -0.601, -0.217, +0.180, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.593, -0.669, -0.788, -0.939, -1.103, -1.265, -1.401, -1.484, -1.490, -1.414, -1.269, -1.082, -0.873, -0.645, &
       -0.401, -0.134, +0.162, +0.493, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.526, -0.521, -0.521, -0.537, &
       -0.581, -0.642, -0.699, -0.729, -0.715, -0.651, -0.540, -0.393, -0.219, -0.027, +0.184, +0.413, +0.663, +0.930, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.523, -0.506, -0.467, -0.401, -0.308, -0.206, -0.112, -0.036, &
       +0.035, +0.110, +0.199, +0.308, +0.439, +0.592, +0.766, +0.961, +1.179, +1.419, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.528, -0.513, -0.471, -0.389, -0.248, -0.040, +0.214, +0.458, +0.650, +0.786, +0.894, +0.991, &
       +1.093, +1.208, +1.344, +1.501, +1.684, +1.889, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.522, -0.516, &
       -0.485, -0.410, -0.266, -0.030, +0.292, +0.660, +0.999, +1.261, +1.444, +1.574, +1.679, +1.779, +1.886, +2.012, &
       +2.158, +2.327, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.493, -0.491, -0.474, -0.418, -0.291, -0.066, &
       +0.264, +0.670, +1.094, +1.479, +1.783, +1.995, +2.146, +2.262, +2.366, +2.473, +2.594, +2.730, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.476, -0.470, -0.453, -0.404, -0.294, -0.095, +0.209, +0.605, +1.054, +1.507, &
       +1.907, +2.220, +2.446, +2.612, +2.747, +2.865, +2.974, +3.089, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.463, -0.451, -0.428, -0.381, -0.282, -0.103, +0.172, +0.538, +0.971, +1.440, +1.905, +2.320, +2.643, +2.878, &
       +3.049, +3.185, +3.299, +3.406, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.459, -0.441, -0.414, -0.363, &
       -0.268, -0.101, +0.156, +0.499, +0.910, +1.367, +1.846, +2.318, +2.733, +3.054, +3.284, +3.457, +3.593, +3.704, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.460, -0.440, -0.409, -0.357, -0.263, -0.102, +0.144, +0.476, &
       +0.878, +1.325, +1.800, +2.285, +2.753, +3.155, +3.461, +3.683, +3.856, +3.987, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.459, -0.440, -0.408, -0.355, -0.263, -0.108, +0.131, +0.460, +0.863, +1.314, +1.789, +2.275, &
       +2.763, +3.218, +3.593, +3.872, +4.082, +4.251, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.447, -0.427, &
       -0.395, -0.342, -0.254, -0.105, +0.129, +0.455, +0.863, +1.322, +1.806, +2.300, +2.795, +3.273, +3.697, +4.033, &
       +4.284, +4.484, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.431, -0.411, -0.374, -0.317, -0.230, -0.088, &
       +0.137, +0.461, +0.872, +1.342, +1.840, +2.347, +2.851, +3.342, +3.794, +4.174, +4.467, +4.687, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.418, -0.396, -0.355, -0.289, -0.191, -0.047, +0.172, +0.489, +0.899, +1.374, &
       +1.882, +2.400, +2.919, +3.426, +3.897, +4.307, +4.627, +4.861, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.410, -0.387, -0.342, -0.265, -0.151, +0.010, +0.237, +0.550, +0.952, +1.423, +1.935, +2.463, +2.995, +3.516, &
       +4.003, +4.432, +4.771, +5.017, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.408, -0.383, -0.336, -0.253, &
       -0.121, +0.068, +0.320, +0.646, +1.046, +1.505, +2.007, +2.534, +3.071, +3.601, +4.101, +4.541, +4.894, +5.128, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.409, -0.385, -0.341, -0.257, -0.116, +0.097, +0.384, +0.739, &
       +1.151, +1.607, +2.095, +2.609, +3.139, +3.668, +4.172, +4.620, +4.959, +5.199, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.411, -0.389, -0.348, -0.271, -0.132, +0.091, +0.404, +0.792, +1.228, +1.691, +2.174, +2.674, &
       +3.188, +3.706, +4.203, +4.644, +4.988, +5.247, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.412, -0.392, &
       -0.355, -0.284, -0.155, +0.062, +0.379, +0.783, +1.243, +1.725, +2.214, +2.708, +3.207, +3.705, +4.186, +4.616, &
       +4.967, +5.252, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.412, -0.393, -0.359, -0.296, -0.178, +0.026, &
       +0.334, +0.734, +1.199, +1.694, +2.196, +2.694, +3.186, +3.669, +4.132, +4.550, +4.921, +5.210, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.414, -0.395, -0.362, -0.304, -0.197, -0.009, +0.283, +0.671, +1.126, +1.620, &
       +2.130, +2.637, +3.133, +3.611, +4.063, +4.477, +4.849, +5.132, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.410, -0.393, -0.361, -0.307, -0.208, -0.033, +0.241, +0.611, +1.054, +1.542, +2.052, +2.566, +3.068, +3.551, &
       +4.001, +4.415, +4.780, +5.047, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.401, -0.384, -0.353, -0.302, &
       -0.209, -0.046, +0.212, +0.567, +0.999, +1.480, +1.987, +2.503, +3.012, +3.501, +3.955, +4.370, +4.717, +4.976, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.386, -0.369, -0.339, -0.289, -0.203, -0.050, +0.196, +0.540, &
       +0.963, +1.440, +1.946, +2.462, +2.973, +3.467, +3.926, +4.336, +4.669, +4.905, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.357, -0.341, -0.312, -0.264, -0.181, -0.037, +0.197, +0.530, +0.949, +1.425, +1.929, +2.443, &
       +2.953, +3.447, +3.906, +4.307, +4.614, +4.812, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.313, -0.297, &
       -0.268, -0.222, -0.143, -0.005, +0.219, +0.541, +0.953, +1.425, +1.928, +2.438, +2.944, +3.432, +3.881, +4.263, &
       +4.541, +4.714, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.256, -0.235, -0.203, -0.156, -0.079, +0.053, &
       +0.267, +0.576, +0.975, +1.438, +1.934, +2.439, +2.935, +3.406, +3.833, +4.187, +4.441, +4.601, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.207, -0.174, -0.132, -0.079, +0.001, +0.131, +0.337, +0.632, +1.014, +1.461, &
       +1.946, +2.439, +2.916, +3.357, +3.750, +4.074, +4.314, +4.473, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.181, -0.132, -0.074, -0.004, +0.087, +0.220, +0.421, +0.701, +1.061, +1.487, +1.954, +2.431, +2.880, +3.281, &
       +3.631, +3.930, +4.168, +4.333, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.195, -0.131, -0.053, +0.038, &
       +0.150, +0.299, +0.503, +0.771, +1.109, +1.511, +1.957, +2.409, +2.823, +3.179, +3.490, +3.771, +4.012, +4.183, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.245, -0.172, -0.082, +0.029, +0.165, +0.338, +0.554, +0.819, &
       +1.140, +1.520, +1.941, +2.366, +2.744, +3.061, +3.340, +3.609, +3.850, +4.033, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.311, -0.241, -0.146, -0.025, +0.128, +0.322, +0.558, +0.835, +1.154, +1.515, +1.910, +2.303, &
       +2.649, +2.934, +3.191, +3.449, +3.689, +3.895, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.374, -0.315, &
       -0.229, -0.110, +0.046, +0.252, +0.509, +0.809, +1.139, +1.494, +1.866, +2.229, +2.544, +2.805, +3.047, +3.295, &
       +3.537, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.418, -0.375, -0.307, -0.204, -0.055, +0.152, &
       +0.421, +0.741, +1.092, +1.454, +1.814, +2.151, +2.439, +2.680, +2.909, +3.149, +3.399, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.446, -0.420, -0.372, -0.291, -0.161, +0.035, +0.306, +0.642, +1.017, +1.396, &
       +1.755, +2.073, +2.338, +2.562, +2.780, +3.015, +3.274, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.457, -0.442, -0.412, -0.355, -0.253, -0.080, +0.184, +0.532, +0.930, +1.329, +1.691, +1.997, +2.243, +2.453, &
       +2.661, +2.895, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.462, -0.452, -0.434, -0.398, &
       -0.324, -0.181, +0.064, +0.416, +0.836, +1.256, +1.625, +1.923, +2.155, +2.354, +2.554, +2.790, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.463, -0.456, -0.444, -0.421, -0.372, -0.263, -0.050, +0.292, &
       +0.727, +1.174, +1.557, +1.851, +2.075, +2.266, +2.464, +2.697, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.464, -0.458, -0.449, -0.432, -0.398, -0.320, -0.147, +0.165, +0.601, +1.072, +1.479, +1.781, &
       +2.003, +2.190, +2.388, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.465, -0.460, &
       -0.451, -0.438, -0.413, -0.355, -0.219, +0.052, +0.470, +0.955, +1.388, +1.708, +1.936, +2.125, +2.323, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.465, -0.460, -0.453, -0.442, -0.421, -0.374, &
       -0.266, -0.037, +0.347, +0.829, +1.285, +1.629, +1.871, +2.067, +2.267, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.464, -0.460, -0.454, -0.444, -0.424, -0.383, -0.291, -0.096, +0.249, +0.714, &
       +1.181, +1.548, +1.809, +2.014, +2.216, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.463, -0.460, -0.454, -0.445, -0.427, -0.390, -0.308, -0.136, +0.178, +0.619, +1.087, +1.470, +1.748, +1.964, &
       +2.172, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.462, -0.457, -0.452, -0.443, &
       -0.427, -0.393, -0.316, -0.158, +0.129, +0.545, +1.006, +1.401, +1.695, +1.922, +2.133, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.460, -0.454, -0.448, -0.440, -0.425, -0.392, -0.321, -0.173, &
       +0.096, +0.491, +0.940, +1.341, +1.650, +1.889, +2.097, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.458, -0.451, -0.443, -0.433, -0.418, -0.387, -0.320, -0.181, +0.073, +0.451, +0.888, +1.292, &
       +1.612, +1.858, +2.064, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.460, -0.450, &
       -0.439, -0.426, -0.408, -0.377, -0.314, -0.184, +0.058, +0.420, +0.847, +1.252, +1.579, +1.829, +2.020, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.463, -0.454, -0.441, -0.423, -0.400, -0.365, &
       -0.303, -0.180, +0.049, +0.397, +0.815, +1.218, +1.548, +1.788, +1.976, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.466, -0.459, -0.447, -0.428, -0.400, -0.357, -0.289, -0.169, +0.048, +0.382, &
       +0.790, +1.188, +1.504, +1.732, +1.922, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.468, -0.463, -0.454, -0.439, -0.409, -0.359, -0.281, -0.154, +0.057, +0.377, +0.770, +1.155, +1.454, +1.668, &
       +1.839, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.468, -0.465, -0.460, -0.450, &
       -0.425, -0.375, -0.286, -0.146, +0.071, +0.382, +0.756, +1.115, +1.391, +1.586, +1.752, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.469, -0.466, -0.462, -0.456, -0.440, -0.397, -0.308, -0.154, &
       +0.078, +0.388, +0.741, +1.066, +1.310, +1.484, +1.666, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.469, -0.467, -0.464, -0.460, -0.449, -0.417, -0.337, -0.181, +0.065, +0.380, +0.713, +1.002, &
       +1.215, +1.382, +1.572, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.470, -0.467, &
       -0.465, -0.462, -0.454, -0.431, -0.366, -0.219, +0.030, +0.347, +0.661, +0.919, +1.109, +1.277, +1.479, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.470, -0.468, -0.466, -0.463, -0.457, -0.439, &
       -0.387, -0.258, -0.021, +0.289, +0.588, +0.821, +1.000, +1.171, +1.387, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.470, -0.468, -0.466, -0.464, -0.459, -0.444, -0.403, -0.293, -0.077, +0.215, &
       +0.499, +0.718, +0.890, +1.067, +1.301, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.470, -0.469, -0.467, -0.466, -0.461, -0.449, -0.414, -0.321, -0.131, +0.138, +0.406, +0.615, +0.784, +0.968, &
       +1.218, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.471, -0.469, -0.468, -0.467, &
       -0.463, -0.453, -0.423, -0.343, -0.178, +0.064, +0.314, +0.517, +0.683, +0.876, +1.137, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.471, -0.470, -0.469, -0.468, -0.465, -0.456, -0.430, -0.363, &
       -0.220, -0.005, +0.227, +0.421, +0.591, +0.789, +1.058, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.472, -0.471, -0.469, -0.468, -0.466, -0.459, -0.437, -0.380, -0.257, -0.068, +0.144, +0.331, &
       +0.502, +0.706, +0.991, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.472, -0.471, &
       -0.470, -0.469, -0.467, -0.461, -0.443, -0.395, -0.291, -0.125, +0.067, +0.246, +0.418, +0.632, +0.925, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.473, -0.471, -0.470, -0.469, -0.468, -0.463, &
       -0.448, -0.408, -0.319, -0.176, -0.004, +0.166, +0.343, +0.565, +0.860, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.473, -0.472, -0.471, -0.470, -0.468, -0.464, -0.451, -0.418, -0.343, -0.220, &
       -0.065, +0.096, +0.275, +0.501, +0.804, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.474, -0.472, -0.472, -0.471, -0.469, -0.464, -0.453, -0.425, -0.362, -0.256, -0.117, +0.036, +0.214, +0.443, &
       +0.751, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.475, -0.473, -0.473, -0.472, &
       -0.469, -0.465, -0.454, -0.428, -0.375, -0.283, -0.159, -0.013, +0.162, +0.392, +0.701, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.476, -0.474, -0.474, -0.473, -0.470, -0.465, -0.454, -0.430, &
       -0.383, -0.302, -0.190, -0.052, +0.119, +0.345, +0.656, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.477, -0.475, -0.475, -0.474, -0.472, -0.466, -0.454, -0.431, -0.387, -0.313, -0.211, -0.081, &
       +0.082, +0.303, +0.612, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.477, -0.477, &
       -0.476, -0.475, -0.474, -0.469, -0.456, -0.432, -0.389, -0.320, -0.224, -0.103, +0.049, +0.264, +0.566, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.479, -0.478, -0.478, -0.477, -0.476, -0.471, &
       -0.459, -0.435, -0.392, -0.324, -0.233, -0.122, +0.021, +0.224, +0.522, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.480, -0.479, -0.479, -0.479, -0.477, -0.474, -0.464, -0.440, -0.397, -0.329, &
       -0.241, -0.140, -0.010, +0.184, +0.484, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.482, -0.481, -0.481, -0.480, -0.479, -0.477, -0.468, -0.447, -0.405, -0.338, -0.254, -0.161, -0.042, +0.146, &
       +0.445, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.483, -0.483, -0.483, -0.482, &
       -0.481, -0.479, -0.472, -0.454, -0.415, -0.350, -0.270, -0.185, -0.074, +0.110, +0.407, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.486, -0.485, -0.485, -0.484, -0.484, -0.482, -0.476, -0.461, &
       -0.426, -0.366, -0.291, -0.212, -0.105, +0.073, +0.371, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.488, -0.487, -0.487, -0.487, -0.486, -0.485, -0.480, -0.467, -0.436, -0.383, -0.314, -0.240, &
       -0.137, +0.039, +0.339, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.490, -0.490, &
       -0.490, -0.489, -0.489, -0.487, -0.484, -0.473, -0.446, -0.399, -0.338, -0.267, -0.168, +0.006, +0.313, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.493, -0.493, -0.492, -0.492, -0.491, -0.490, &
       -0.487, -0.478, -0.456, -0.415, -0.360, -0.294, -0.199, -0.027, +0.287, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.496, -0.495, -0.495, -0.495, -0.494, -0.493, -0.491, -0.483, -0.464, -0.429, &
       -0.380, -0.319, -0.228, -0.059, +0.247, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.499, -0.499, -0.498, -0.498, -0.498, -0.497, -0.495, -0.488, -0.472, -0.442, -0.399, -0.343, -0.256, -0.098, &
       +0.211, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.502, -0.502, -0.502, -0.502, &
       -0.501, -0.501, -0.499, -0.493, -0.479, -0.453, -0.415, -0.367, -0.284, -0.142, +0.204, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.506, -0.506, -0.506, -0.506, -0.505, -0.505, -0.503, -0.498, &
       -0.486, -0.464, -0.431, -0.389, -0.327, -0.169, +0.220, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, -0.510, -0.510, -0.510, -0.510, -0.509, -0.509, -0.507, -0.503, -0.493, -0.474, -0.447, -0.414, &
       -0.359, -0.177, +0.203, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.515, -0.515, &
       -0.515, -0.514, -0.514, -0.514, -0.512, -0.509, -0.500, -0.485, -0.463, -0.438, -0.383, -0.196, +0.165, +0.000, &
       +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, -0.520, -0.520, -0.520, -0.520, -0.519, -0.519, &
       -0.518, -0.515, -0.507, -0.495, -0.479, -0.461, -0.411, -0.249, +0.151, +0.000, +0.000, +0.000, +0.000, +0.000, &
       +0.000, +0.000, +0.000, +0.000, -0.526, -0.526, -0.526, -0.526, -0.525, -0.525, -0.524, -0.521, -0.515, -0.506, &
       -0.495, -0.484, -0.466, -0.311, +0.197, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, &
       -0.533, -0.533, -0.533, -0.532, -0.532, -0.532, -0.531, -0.529, -0.524, -0.518, -0.511, -0.515, -0.536, -0.295, &
       +0.168, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000, +0.000], [sample_r, sample_t]))
      
    
    nb_r_points = sample_r
    nb_t_points = sample_t
    
    if (allocated(hure_k_table)) then
      deallocate(hure_r)
      deallocate(hure_t)
      deallocate(hure_k_table)
    end if
    
    allocate(hure_r(nb_r_points))
    allocate(hure_t(nb_t_points))
    allocate(hure_k_table(nb_t_points, nb_r_points))
    
    hure_r(1:nb_r_points) = log_r(1:sample_r)
    hure_t(1:nb_t_points) = log_t(1:sample_t)
    
    hure_k_table(1:nb_t_points, 1:nb_r_points) = kappa(1:nb_t_points, 1:nb_r_points)
    
    ! We initialise the two width, for temperature and r, between each sample value
    ! /!\ these widths must be constant over the opacity table
    ! dlog_t and dlog_r must be as accurate as possible to avoid problem for the last point because a 
    ! thousand times a tiny difference can make a difference of 1 here, which in turn might become a bad index problem in the array
    dlog_t = (hure_t(nb_t_points) - hure_t(1)) / dfloat(nb_t_points - 1)
    dlog_r = (hure_r(nb_r_points) - hure_r(1)) / dfloat(nb_r_points - 1)
    
    
    
    return
  end subroutine init_opacity_hure

  subroutine linear_interpolation(x1, y1, x2, y2, x, y)
  
  implicit none
  
  real(double_precision), intent(in) :: x1, y1, x2, y2 ! the two points used to interpolate
  real(double_precision), intent(in) :: x ! the x coordinate of the point where we want the y coordinate
  real(double_precision), intent(out) :: y
  
  y = (y2 - y1) * (x - x1) / (x2 - x1) + y1
  
  return 
  end subroutine linear_interpolation

  function get_opacity_hure(temperature, num_bulk_density)
  ! subroutine that return the opacity of the disk at the location of the planet given various parameters
  ! must have the structure defined in disk_parameters.f90 to allow pointers to be used
  !
  ! BEHAVIOR : 
  ! The routine will interpolate linearly for the R axis and for the T axis (both being in log10), making a bilinear 
  ! interpolation in T and R. Thus it is more or less a power law interpolation. When out of range,  there is either a linear 
  ! interpolation (if only out of range for one axis) or just picking the closest value. When out of range, we assumed a constant 
  ! value which is the closest extremal value.
  
  implicit none
  real(double_precision), intent(in) :: temperature ! temperature of the disk [K]
  real(double_precision), intent(in) :: num_bulk_density ! bulk density of the gas disk [MSUN/AU^3] (in numerical units)
  
  real(double_precision) :: get_opacity_hure ! the opacity in numerical units (AU**2/MSUN)
  
  ! parameters
  real(double_precision), parameter :: num_to_phys_bulk_density = MSUN / AU**3
  real(double_precision), parameter :: phys_to_num_opacity = MSUN / AU**2
  
  ! locals
  real(double_precision) :: bulk_density
  real(double_precision) :: log_t, log_r
  real(double_precision) :: t1, t2, r1, r2
  integer :: id_t1, id_t2, id_r1, id_r2
  real(double_precision) :: p11, p12, p21, p22
  real(double_precision) :: p1, p2 ! temporary points for the interpolation done on temperature axis.
  
  !-----------------------------
  ! we convert the bulk_density from numerical units(AU, MS, DAY) to physical units (CGS)
  bulk_density = num_to_phys_bulk_density * num_bulk_density
  
  log_t = log10(temperature)
  log_r = log10(bulk_density) + 18.d0 - 3.d0 * log_t
  
  ! dlog_t and dlog_r must be as accurate as possible to avoid problem for the last point because a 
  ! thousand times a tiny difference can make a difference of 1 here, which in turn might become a bad index problem in the array
  id_t1 = 1 + int((log_t - hure_t(1)) / dlog_t)
  id_r1 = 1 + int((log_r - hure_r(1)) / dlog_r)
  
  
  ! if exterior or equal to the boundaries, we consider the boundaries, without interpolation. 
  ! actually there will be an interpolation, but between equal values.
  if (log_t.lt.hure_t(1)) then
    id_t1 = 1
    id_t2 = id_t1
  else if (log_t.ge.hure_t(nb_t_points)) then
    id_t1 = nb_t_points
    id_t2 = id_t1
  else 
    id_t2 = id_t1 +1
  end if
  
  if (log_r.lt.hure_r(1)) then
    id_r1 = 1
    id_r2 = id_r1
  else if (log_r.ge.hure_t(nb_r_points)) then
    id_r1 = nb_r_points
    id_r2 = id_r1
  else
    id_r2 = id_r1 + 1
  end if
  
  t1 = hure_t(id_t1)
  t2 = hure_t(id_t2)
  r1 = hure_r(id_r1)
  r2 = hure_r(id_r2)
  
  
  !    p12                     p22
  ! r2 +-----------------------+
  !    |                       |
  !    |                       |
  !    |                       |
  !    |                       |
  !    |                       |
  !    |                       |
  ! r1 +-----------------------+
  !    p11                     p21
  !    t1                      t2
  
  p11 = hure_k_table(id_t1, id_r1)
  p12 = hure_k_table(id_t1, id_r2)
  p21 = hure_k_table(id_t2, id_r1)
  p22 = hure_k_table(id_t2, id_r2)
  
  if (id_t1.ne.id_t2) then
    call linear_interpolation(x1=t1, y1=p11, x2=t2, y2=p21, x=log_t, y=p1) ! for r=r1
    call linear_interpolation(x1=t1, y1=p12, x2=t2, y2=p22, x=log_t, y=p2) ! for r=r2
  else
    p1 = p11
    p2 = p22
  end if
  
  if (id_r1.ne.id_r2) then
    call linear_interpolation(x1=r1, y1=p1, x2=r2, y2=p2, x=log_r, y=get_opacity_hure)
  else
    get_opacity_hure = p1
  end if
  
!~   write(*,*) '----------------------------------'
!~   write(*,*) 'temperature=', temperature, "; bulk_density=", bulk_density
!~   write(*,*) 'log_T =', log_t, '; log_r =', log_r
!~   write(*,*) id_t1, id_t2, id_r1, id_r2
!~   write(*,*) p11, p12, p21, p22
!~   write(*,*) p1, p2
!~   write(*,*) get_opacity_hure
!~   write(*,*) '----------------------------------'
  
  ! we do not want log(opacity) but simply the opacity
  get_opacity_hure = 10.0d0**(get_opacity_hure)
  
  ! we change the opacity from physical units to numerical units
  get_opacity_hure = phys_to_num_opacity * get_opacity_hure
  
 
  end function get_opacity_hure
  
  subroutine test_opacity_interpolation()
  
  implicit none
  
  integer :: ti, ri, i
  
  real(double_precision), parameter :: T_min = 10.
  real(double_precision), parameter :: T_max = 1.d8
  integer, parameter :: nb_T = 200
  real(double_precision), parameter :: T_step = (T_max/T_min)**(1/(nb_T-1.d0))
  real(double_precision) :: density, temperature, num_density, r_density
  
  real(double_precision), parameter :: R_min = 10.d0**(-7.5d0)
  real(double_precision), parameter :: R_max = 10.d0**(2.5d0)
  integer, parameter :: nb_R = 200
  real(double_precision), parameter :: R_step = (R_max/R_min)**(1/(nb_R-1.d0))
  
  real(double_precision), parameter :: phys_to_num_bulk_density = AU**3 / MSUN
  real(double_precision), parameter :: num_to_phys_opacity = AU**2 / MSUN
  
  real(double_precision) :: log_t, log_r
  
  write (*,*) 'Test of the opacity table by Hure. (Two output surface plot, the raw table and the interpolation)'
  
  call init_opacity_hure()
  
  open(10, file='unitary_tests/opacity_bilinear.dat', status='replace')
  do ti=1, nb_T
    temperature = T_min * T_step ** (ti-1)
    log_t = log10(temperature)
    do ri=1,nb_R
      r_density = R_min * R_step ** (ri -1)
      log_r = log10(r_density)
      
      density = 10.d0**(log_r + 3.d0 * log_t - 18.d0)
      num_density = density * phys_to_num_bulk_density
      
      
      write(10,*) log_t, log_r, log10(get_opacity_hure(temperature=temperature, num_bulk_density=num_density) * num_to_phys_opacity)
    end do
    write(10,*) ''
  end do
  close(10)
  
  open(unit=10, file="unitary_tests/opacity_table_hure.dat", status='replace')
  do ti=1, nb_t_points
    do ri=1, nb_r_points
      write(10, *) hure_t(ti), hure_r(ri), hure_k_table(ti, ri)
    end do
    write(10,*) ''
  end do
  close(10)
  
  open(10, file='unitary_tests/opacity_bilinear.gnuplot')
  open(11, file='unitary_tests/opacity_hure.gnuplot')
  do i=10,11
    write(i, '(a)') "set terminal pngcairo crop enhanced size 1200, 1000 font ',20'"
    write(i, '(a)') '#set terminal wxt enhanced'
  end do
  
  write(10, '(a)') 'set output "opacity_bilinear_interpolation.png"'
  write(11, '(a)') 'set output "opacity_raw_table.png"'
  
  do i=10,11
    write(i, '(a)') 'set xlabel "temperature (K)"'
    write(i, '(a)') 'set ylabel "R ({/Symbol \265 r}*t^3)" center'
  end do
  
  write(10, '(a)') 'set title "opacity bilinear interpolation"'
  write(11, '(a)') 'set title "raw opacity table (hure)"'
  
  do i=10,11
    write(i, '(a)') 'set pm3d map'
    write(i, '(a)') 'set pm3d explicit'
    write(i, '(a)') 'set palette rgbformulae 22,13,-31'
    write(i, '(a)') 'set grid xtics ytics linetype 0'
    write(i, '(a)') 'set xrange [1:8]'
    write(i, '(a)') 'set yrange [-7.5:2.5]'
  end do
  
  write(10, '(a)') 'splot "opacity_bilinear.dat" with pm3d notitle'
  write(11, '(a)') 'splot "opacity_table_hure.dat" with pm3d notitle'
  
  close(10)
  close(11)
  
  end subroutine test_opacity_interpolation

end module opacity_hure
